name: "Civilization II: Test of Time (TOTPP v0.18.4)"
game_slug: test-of-time-totpp-18-4
version: "Install Test of Time With Test of Time Patch Project v0.18.4"
slug: test-of-time-installer
runner: wine

script:
    game:
        exe: $GAMEDIR/drive_c/Test of Time/TOTLauncher.exe
        prefix: $GAMEDIR
        working_dir: $GAMEDIR/drive_c/Test of Time
    files:
    - installer-zip:
        url: https://github.com/ProfGarfield/lutris-installer/archive/refs/heads/main.zip
        filename: "Installation Files Zip"
        referrer: github.com/ProfGarfield
    - music:
        url: https://github.com/ProfGarfield/ExtendedMusicForTOTPP/archive/refs/heads/main.zip
        filename: "Extended Music for TOTPP"
        referrer: github.com/ProfGarfield  
    installer:
    - task:
         arch: win32
         name: create_prefix
         prefix: $GAMEDIR
    - insert-disc:
        requires: Civ2/civ2.exe
    - input_menu:
        description: "The Test of Time installer is about to run.  Install the game to the default suggested directory (C:\\Program Files\\Microprose\\Test of Time).  This script will automatically move the game files to a different directory at the appropriate time.  It doesn't matter if you install the DirectX 6 drivers or not."
        options:
            - Yes: "Begin Installation."
            - AlsoYes: ""
    - task:
        arch: win32
        executable: $DISC/SETUP.EXE
        name: wineexec
        prefix: $GAMEDIR
        working_dir: $DISC
    - extract:
        dst: $GAMEDIR/drive_c/lutris-installer-main
        file: installer-zip
        format: zip
    - extract:
        description: "Extracting the Official Time Threat Paradox Scenario..."
        dst: $GAMEDIR/drive_c
        file: $GAMEDIR/drive_c/lutris-installer-main/CIVIITTP.rar
        format: rar
    - task:
        description: "Running the Official Time Threat Paradox Scenario installer..."
        arch: win32
        executable: $GAMEDIR/drive_c/CIVIITTP.exe
        name: wineexec
    - task:
        description: "Running the Official Version 1.1 Patcher..."
        arch: win32
        executable: $GAMEDIR/drive_c/lutris-installer-main/civtot11.exe
        name: wineexec
    - move:
        src: "$GAMEDIR/drive_c/Program Files/Microprose/Test of Time"
        dst: $GAMEDIR/drive_c/Test of Time
    - copy:
        description: "Copying Video files to the new Test of Time directory..."
        src: $DISC/Civ2/Video
        dst: $GAMEDIR/drive_c/Test of Time/Video
    - execute:
    # When copying the Video directory, I've noticed that it is read-only (probably because it's from a CD or mounted .iso file).
    # This command makes it writeable (and deletable, in case you want to delete the game).
        command: 'chmod -R u+w "$GAMEDIR/drive_c/Test of Time/Video"'
    - extract:
        dst: $GAMEDIR/drive_c/Test of Time
        file: $GAMEDIR/drive_c/lutris-installer-main/TOTPPv018.4.zip
        format: zip
    - extract:
        dst: $GAMEDIR/drive_c/Test of Time/Midgard
        file: $GAMEDIR/drive_c/lutris-installer-main/Midgard_patch.7z
        format: 7z
    - extract:
        dst: $GAMEDIR/drive_c/Test of Time
        file: music
        format: zip
    - input_menu:
        description: "Extended Music for TOTPP allows you to play any .mp3 file in the Test of Time/Music directory, and write custom playlists.  It will require the Lua Scripting patch to be active while playing the game."
        id: EXTRAMUSIC
        options:
        - AddToLuaFolder: "Yes, I would like the Extended Music for TOTPP features."
        - empty: "No.  I only care about listening to Test of Time's original music."
    - execute:
        command: 'mkdir "$GAMEDIR/drive_c/Test of Time/empty"'
    - merge:
        src: $GAMEDIR/drive_c/Test of Time/$INPUT_EXTRAMUSIC
        dst: $GAMEDIR/drive_c/Test of Time/lua
    - merge:
        src: $GAMEDIR/drive_c/Test of Time/ModifiedGameTxt
        dst: $GAMEDIR/drive_c/Test of Time/AddToLuaFolder
    - execute:
        command: 'rm -r "$GAMEDIR/drive_c/Test of Time/ModifiedGameTxt"'
    - execute:
        command: 'mkdir "$GAMEDIR/drive_c/Test of Time/empty/Original"'
    - execute:
        command: 'mkdir "$GAMEDIR/drive_c/Test of Time/empty/Fantasy"'
    - execute:
        command: 'mkdir "$GAMEDIR/drive_c/Test of Time/empty/ExtendedOriginal"'
    - execute:
        command: 'mkdir "$GAMEDIR/drive_c/Test of Time/empty/Elsewhere in Time"'
    - execute:
        command: 'mkdir "$GAMEDIR/drive_c/Test of Time/empty/Scifi"'
    - merge:
        src: $GAMEDIR/drive_c/Test of Time/$INPUT_EXTRAMUSIC/Original
        dst: $GAMEDIR/drive_c/Test of Time/Original
    - merge:
        src: $GAMEDIR/drive_c/Test of Time/$INPUT_EXTRAMUSIC/Fantasy
        dst: $GAMEDIR/drive_c/Test of Time/Fantasy
    - merge:
        src: $GAMEDIR/drive_c/Test of Time/$INPUT_EXTRAMUSIC/ExtendedOriginal
        dst: $GAMEDIR/drive_c/Test of Time/ExtendedOriginal
    - merge:
        src: $GAMEDIR/drive_c/Test of Time/$INPUT_EXTRAMUSIC/Elsewhere in Time
        dst: $GAMEDIR/drive_c/Test of Time/Elsewhere in Time
    - merge:
        src: $GAMEDIR/drive_c/Test of Time/$INPUT_EXTRAMUSIC/Scifi
        dst: $GAMEDIR/drive_c/Test of Time/Scifi
    - execute:
        command: 'rm -r "$GAMEDIR/drive_c/Test of Time/empty"'
    - execute:
        command: 'rm -r "$GAMEDIR/drive_c/Test of Time/AddToLuaFolder"'
    - execute:
        command: 'rm  "$GAMEDIR/drive_c/Test of Time/README.md"'
    - write_file:
        file: "$GAMEDIR/batch.bat"
        content: |+
            @ECHO OFF
            
            REM "Modified code from https://stackoverflow.com/questions/25815928/use-a-batch-file-to-list-files-and-allow-the-user-to-select-which-file-to-pass-t"
            
            @ECHO OFF
            SET index=1
            SETLOCAL ENABLEDELAYEDEXPANSION
            cd "drive_c\Test of Time"
            FOR /R %%f IN (*.bat) DO (
               SET file!index!=%%f
               CALL :SHORTEN "%%f"
               ECHO !index! - !fil!
               SET /A index=!index!+1
            )
            SETLOCAL DISABLEDELAYEDEXPANSION
            SET /P selection=Choose the number for the batch file you wish to run:
            SET file%selection% >nul 2>&1
            CALL :RESOLVE %%file%selection%%%
            for %%a in ("%file_name%") do cd %%~dpa
            "%file_name%"
            GOTO :EOF
            
            :RESOLVE
            SET file_name=%1
            GOTO :EOF
            
            :SHORTEN
            SET fil=%1
            SET "fil=%fil:*drive_c=%"
            SET "fil=%fil:\Test of Time\=...%"
            GOTO :EOF
            
            GOTO :EOF
    # wine:
    #    arch: win32
    #    version: lutris-fshack-7.2-x86_64
        # version: lutris-6.14-3-x86_64
    #    dxvk: false
